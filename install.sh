#!/bin/bash

set -euo pipefail

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Arch Dotfiles Install Script
# By: Rajbir (2025)
# Description: Symlinks config files, fixes bad links,
#              installs essentials (fonts, terminal, notifications, waybar)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ Starting dotfiles bootstrap..."

# Set up paths
DOTFILES="$HOME/dotfiles"
CONFIGS=(kitty hypr waybar mako)
LOCAL_BIN="$HOME/.local/bin"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Step 1: Fix any broken/nested symlinks
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐งน Cleaning nested symlinks in dotfiles..."
find "$DOTFILES/.config" -type l | while read -r symlink; do
  target=$(readlink "$symlink")
  if [[ "$target" == *dotfiles* ]]; then
    echo "โ๏ธ  Removing nested symlink: $symlink"
    rm "$symlink"
  fi
done

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Step 2: Symlink configs to ~/.config
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ Creating config symlinks..."
for tool in "${CONFIGS[@]}"; do
  config_path="$HOME/.config/$tool"
  repo_path="$DOTFILES/.config/$tool"

  if [ -e "$config_path" ] || [ -L "$config_path" ]; then
    echo "๐งน Removing existing $config_path"
    rm -rf "$config_path"
  fi

  ln -s "$repo_path" "$config_path"
  echo "โ Linked $tool config"
done

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Step 2.5: Symlink .zshrc from dotfiles/.config/zsh
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ZSHRC_LINK="$HOME/.zshrc"
ZSHRC_SOURCE="$DOTFILES/.config/zsh/.zshrc"

if [ -e "$ZSHRC_LINK" ] || [ -L "$ZSHRC_LINK" ]; then
  echo "๐งน Removing existing ~/.zshrc"
  rm -f "$ZSHRC_LINK"
fi

ln -s "$ZSHRC_SOURCE" "$ZSHRC_LINK"
echo "โ Symlinked .zshrc โ $ZSHRC_SOURCE"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Step 3: Ensure .local/bin exists and is symlinked
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

mkdir -p "$LOCAL_BIN"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Step 4: Install core packages
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ฆ Installing required packages..."
sudo pacman -S --noconfirm \
  kitty \
  zsh \
  ttc-iosevka \
  ttf-iosevka-nerd \
  waybar \
  mako \
  swaybg \
  git \
  base-devel \
  jq

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Step 5: Set zsh as default shell
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

if [ "$SHELL" != "/bin/zsh" ]; then
  echo "๐ Setting zsh as default shell..."
  chsh -s /bin/zsh
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Step 6: Create wallpaper folder (optional)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

mkdir -p "$HOME/Pictures/wallpapers"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Step 7: GitHub SSH Config Reminder (optional)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ (Optional) Set up SSH for GitHub with ssh-keygen if needed."

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Done
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ All done. Log out and back in, or reboot to apply everything."
echo "๐ You may also want to run: source ~/.zshrc"
